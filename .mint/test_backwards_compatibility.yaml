tasks:
  - key: setup
    call: ${{ run.mint-dir }}/setup.yaml
    init:
      commit-sha: ${{ init.commit-sha }}

  - key: build
    use: setup
    run: mage
    env: 
      CGO_ENABLED: 0
      LDFLAGS: -w -s -X github.com/rwx-research/captain-cli.Version=testing-${{ init.commit-sha }}

  - key: checkout-legacy-version
    use: build
    run: |
      git fetch --tags
      git checkout ${{ init.legacy_version }} -- ./test

  - key: test
    use: checkout-legacy-version
    env: 
      CGO_ENABLED: 0
      LEGACY_VERSION_TO_TEST: ${{ init.legacy_version }}
      LDFLAGS: -w -s -X github.com/rwx-research/captain-cli.Version=testing-${{ init.commit-sha }}
      REPORT: true
      RWX_ACCESS_TOKEN: ${{ secrets.RWX_ACCESS_TOKEN }}
      RWX_ACCESS_TOKEN_STAGING: ${{ secrets.RWX_ACCESS_TOKEN_STAGING }} # used from within the tests against staging
    run: ./captain run captain-cli-backwards-compatibility
